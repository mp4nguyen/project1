"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require('angular2/core');
var http_1 = require('angular2/http');
var Observable_1 = require('rxjs/Observable');
var lbservices_1 = require('../../shared/services/lbservices');
var logging_service_1 = require('../../shared/services/logging.service');
var people_model_1 = require('../models/people.model');
var PeopleService = (function () {
    function PeopleService() {
        this.injector = core_1.Injector.resolveAndCreate([lbservices_1.CPeopleApi, logging_service_1.MyLogger, http_1.HTTP_PROVIDERS]);
        this._people = this.injector.get(lbservices_1.CPeopleApi);
        this._log = this.injector.get(logging_service_1.MyLogger);
        this.countContructor = 0;
        this.countContructor++;
        console.log('People server constructor ....................................................................', this.countContructor);
    }
    PeopleService.prototype.getPeople = function (personIds) {
        var _this = this;
        var obs = new Observable_1.Observable(function (observer) {
            if (_this.people) {
                observer.next(_this.people);
            }
            else {
                _this._people.find({ where: { personId: { inq: personIds } } })
                    .map(function (res) {
                    var people = [];
                    for (var _i = 0, res_1 = res; _i < res_1.length; _i++) {
                        var c = res_1[_i];
                        var person = new people_model_1.People(c);
                        people.push(person);
                    }
                    return people;
                })
                    .subscribe(function (data) { console.log("Get from server = ", data); _this.people = data; observer.next(data); }, function (err) { return console.error(err); }, function () { return console.log('done'); });
            }
        });
        return obs;
    };
    PeopleService.prototype.savePerson = function (personObject) {
        var _this = this;
        var observer;
        var obs = new Observable_1.Observable(function (o) { return observer = o; });
        if (personObject && personObject.personId) {
            var address = personObject.addressGroup;
            this._log.log("People service.address = ", address);
            personObject.address = address.address;
            personObject.ward = address.ward;
            personObject.suburbDistrict = address.suburbDistrict;
            personObject.stateProvince = address.stateProvince;
            personObject.postcode = address.postcode;
            personObject.country = address.country;
            this._log.log("will update this person", personObject);
            this._people.updateAttributes(personObject.personId, personObject).subscribe(function (data) {
                _this._log.log(data);
                observer.next(data);
            }, function (err) { _this._log.log(err); }, function () { _this._log.log('updated !'); });
        }
        else {
            personObject.personId = 0;
            var address = personObject.addressGroup;
            this._log.log("People service.address = ", address);
            personObject.address = address.address;
            personObject.ward = address.ward;
            personObject.suburbDistrict = address.suburbDistrict;
            personObject.stateProvince = address.stateProvince;
            personObject.postcode = address.postcode;
            personObject.country = address.country;
            this._log.log("Will create this person", personObject);
            this._people.create(personObject).subscribe(function (data) {
                observer.next(data);
            }, function (err) { _this._log.log(err); }, function () { _this._log.log('created !'); });
        }
        return obs;
    };
    PeopleService = __decorate([
        core_1.Injectable(), 
        __metadata('design:paramtypes', [])
    ], PeopleService);
    return PeopleService;
}());
exports.PeopleService = PeopleService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBlb3BsZS9zZXJ2aWNlcy9wZW9wbGUuc2VydmljZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLHFCQUFrQyxlQUFlLENBQUMsQ0FBQTtBQUNsRCxxQkFBK0YsZUFBZSxDQUFDLENBQUE7QUFDL0csMkJBQXlCLGlCQUFpQixDQUFDLENBQUE7QUFJM0MsMkJBQXlCLGtDQUFrQyxDQUFDLENBQUE7QUFDNUQsZ0NBQXVCLHVDQUF1QyxDQUFDLENBQUE7QUFDL0QsNkJBQXFCLHdCQUF3QixDQUFDLENBQUE7QUFJOUM7SUFRRTtRQUpRLGFBQVEsR0FBTyxlQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyx1QkFBVSxFQUFDLDBCQUFRLEVBQUMscUJBQWMsQ0FBQyxDQUFDLENBQUM7UUFDL0UsWUFBTyxHQUFjLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLHVCQUFVLENBQUMsQ0FBQztRQUNuRCxTQUFJLEdBQVksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsMEJBQVEsQ0FBQyxDQUFDO1FBQzVDLG9CQUFlLEdBQVMsQ0FBQyxDQUFDO1FBRWhDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUV2QixPQUFPLENBQUMsR0FBRyxDQUFDLGdHQUFnRyxFQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUNySSxDQUFDO0lBRUQsaUNBQVMsR0FBVCxVQUFVLFNBQW1CO1FBQTdCLGlCQXdCQztRQXRCQyxJQUFJLEdBQUcsR0FBSSxJQUFJLHVCQUFVLENBQUMsVUFBQSxRQUFRO1lBRTlCLEVBQUUsQ0FBQSxDQUFDLEtBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFDO2dCQUNkLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzdCLENBQUM7WUFBQSxJQUFJLENBQUEsQ0FBQztnQkFDSixLQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBQyxFQUFDLFFBQVEsRUFBQyxFQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUMsRUFBQyxFQUFDLENBQUM7cUJBQ3JELEdBQUcsQ0FBQyxVQUFDLEdBQUc7b0JBQ1AsSUFBSSxNQUFNLEdBQWtCLEVBQUUsQ0FBQztvQkFDL0IsR0FBRyxDQUFBLENBQVUsVUFBRyxFQUFILFdBQUcsRUFBSCxpQkFBRyxFQUFILElBQUcsQ0FBQzt3QkFBYixJQUFJLENBQUMsWUFBQTt3QkFDUCxJQUFJLE1BQU0sR0FBVSxJQUFJLHFCQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ2xDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7cUJBQ3JCO29CQUNELE1BQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQ2hCLENBQUMsQ0FBQztxQkFDRCxTQUFTLENBQ1IsVUFBQSxJQUFJLElBQUssT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBQyxJQUFJLENBQUMsQ0FBQyxDQUFBLEtBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLENBQUEsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBLENBQUMsRUFDeEYsVUFBQSxHQUFHLElBQUksT0FBQSxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFsQixDQUFrQixFQUN6QixjQUFNLE9BQUEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBbkIsQ0FBbUIsQ0FDMUIsQ0FBQztZQUNKLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRUQsa0NBQVUsR0FBVixVQUFXLFlBQW1CO1FBQTlCLGlCQTREQztRQTNEQyxJQUFJLFFBQVksQ0FBQztRQUNqQixJQUFJLEdBQUcsR0FBRyxJQUFJLHVCQUFVLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxRQUFRLEdBQUcsQ0FBQyxFQUFaLENBQVksQ0FBQyxDQUFDO1FBQzVDLEVBQUUsQ0FBQSxDQUFDLFlBQVksSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUEsQ0FBQztZQUV4QyxJQUFJLE9BQU8sR0FBRyxZQUFZLENBQUMsWUFBWSxDQUFDO1lBRXhDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLDJCQUEyQixFQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRW5ELFlBQVksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztZQUN2QyxZQUFZLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDakMsWUFBWSxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDO1lBQ3JELFlBQVksQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQztZQUNuRCxZQUFZLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7WUFDekMsWUFBWSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1lBRXZDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLHlCQUF5QixFQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBQyxZQUFZLENBQUMsQ0FBQyxTQUFTLENBQ3pFLFVBQUEsSUFBSTtnQkFDRixLQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFRcEIsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QixDQUFDLEVBQ0QsVUFBQSxHQUFHLElBQUssS0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQSxDQUFDLEVBQzVCLGNBQU8sS0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQSxDQUFDLENBQ2xDLENBQUM7UUFDTixDQUFDO1FBQUEsSUFBSSxDQUFBLENBQUM7WUFFSixZQUFZLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztZQUUxQixJQUFJLE9BQU8sR0FBRyxZQUFZLENBQUMsWUFBWSxDQUFDO1lBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLDJCQUEyQixFQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRW5ELFlBQVksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztZQUN2QyxZQUFZLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDakMsWUFBWSxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDO1lBQ3JELFlBQVksQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQztZQUNuRCxZQUFZLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7WUFDekMsWUFBWSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1lBRXZDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLHlCQUF5QixFQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FDekMsVUFBQSxJQUFJO2dCQUtGLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEIsQ0FBQyxFQUNELFVBQUEsR0FBRyxJQUFLLEtBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUEsQ0FBQyxFQUM1QixjQUFPLEtBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUEsQ0FBQyxDQUNsQyxDQUFDO1FBQ04sQ0FBQztRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDO0lBckdIO1FBQUMsaUJBQVUsRUFBRTs7cUJBQUE7SUE0TWIsb0JBQUM7QUFBRCxDQTNNQSxBQTJNQyxJQUFBO0FBM01ZLHFCQUFhLGdCQTJNekIsQ0FBQSIsImZpbGUiOiJwZW9wbGUvc2VydmljZXMvcGVvcGxlLnNlcnZpY2VzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlLEluamVjdG9yfSBmcm9tICdhbmd1bGFyMi9jb3JlJztcbmltcG9ydCB7SHR0cCwgSGVhZGVycywgUmVxdWVzdCwgUmVzcG9uc2UsQ29ubmVjdGlvbkJhY2tlbmQsUmVxdWVzdE9wdGlvbnMsSFRUUF9QUk9WSURFUlN9IGZyb20gJ2FuZ3VsYXIyL2h0dHAnO1xuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xuLy9pbXBvcnQgJ3J4anMvUngnO1xuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlL3VuZGVyc2NvcmUnO1xuXG5pbXBvcnQge0NQZW9wbGVBcGl9IGZyb20gJy4uLy4uL3NoYXJlZC9zZXJ2aWNlcy9sYnNlcnZpY2VzJztcbmltcG9ydCB7TXlMb2dnZXJ9IGZyb20gJy4uLy4uL3NoYXJlZC9zZXJ2aWNlcy9sb2dnaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHtQZW9wbGV9IGZyb20gJy4uL21vZGVscy9wZW9wbGUubW9kZWwnO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQZW9wbGVTZXJ2aWNlIHtcbiAgXG4gIHByaXZhdGUgcGVvcGxlOiBQZW9wbGVbXTtcbiAgcHJpdmF0ZSBjdXJyZW50UGVvcGxlOiBQZW9wbGU7XG4gIHByaXZhdGUgaW5qZWN0b3I6YW55ID0gSW5qZWN0b3IucmVzb2x2ZUFuZENyZWF0ZShbQ1Blb3BsZUFwaSxNeUxvZ2dlcixIVFRQX1BST1ZJREVSU10pOyAgXG4gIHByaXZhdGUgX3Blb3BsZTpDUGVvcGxlQXBpID0gdGhpcy5pbmplY3Rvci5nZXQoQ1Blb3BsZUFwaSk7XG4gIHByaXZhdGUgX2xvZzpNeUxvZ2dlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KE15TG9nZ2VyKTtcbiAgcHJpdmF0ZSBjb3VudENvbnRydWN0b3I6IG51bWJlcj0wO1xuICBjb25zdHJ1Y3Rvcigpey8vcHJpdmF0ZSBfcGVvcGxlOiBDUGVvcGxlQXBpLCBwcml2YXRlIF9sb2c6IE15TG9nZ2VyXG4gICAgdGhpcy5jb3VudENvbnRydWN0b3IrKztcblxuICAgIGNvbnNvbGUubG9nKCdQZW9wbGUgc2VydmVyIGNvbnN0cnVjdG9yIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uJyx0aGlzLmNvdW50Q29udHJ1Y3Rvcik7XG4gIH1cbiAgICBcbiAgZ2V0UGVvcGxlKHBlcnNvbklkczogbnVtYmVyW10pOk9ic2VydmFibGU8UGVvcGxlPiB7XG4gXG4gICAgbGV0IG9icyA9ICBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiBcbiAgICAgIHtcbiAgICAgICAgaWYodGhpcy5wZW9wbGUpe1xuICAgICAgICAgIG9ic2VydmVyLm5leHQodGhpcy5wZW9wbGUpO1xuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICB0aGlzLl9wZW9wbGUuZmluZCh7d2hlcmU6e3BlcnNvbklkOntpbnE6IHBlcnNvbklkc319fSlcbiAgICAgICAgICAubWFwKChyZXMpPT57IFxuICAgICAgICAgICAgbGV0IHBlb3BsZTogQXJyYXk8UGVvcGxlPiA9IFtdO1xuICAgICAgICAgICAgZm9yKHZhciBjIG9mIHJlcyl7XG4gICAgICAgICAgICAgIGxldCBwZXJzb246UGVvcGxlID0gbmV3IFBlb3BsZShjKTsgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICBwZW9wbGUucHVzaChwZXJzb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHBlb3BsZTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICBkYXRhID0+IHtjb25zb2xlLmxvZyhcIkdldCBmcm9tIHNlcnZlciA9IFwiLGRhdGEpO3RoaXMucGVvcGxlID0gZGF0YTtvYnNlcnZlci5uZXh0KGRhdGEpO30sXG4gICAgICAgICAgICBlcnIgPT4gY29uc29sZS5lcnJvcihlcnIpLFxuICAgICAgICAgICAgKCkgPT4gY29uc29sZS5sb2coJ2RvbmUnKSAgICAgICAgXG4gICAgICAgICAgKTsgIFxuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIG9icztcbiAgfVxuXG4gIHNhdmVQZXJzb24ocGVyc29uT2JqZWN0OlBlb3BsZSk6IE9ic2VydmFibGU8YW55PntcbiAgICBsZXQgb2JzZXJ2ZXI6YW55O1xuICAgIGxldCBvYnMgPSBuZXcgT2JzZXJ2YWJsZShvID0+IG9ic2VydmVyID0gbyk7XG4gICAgaWYocGVyc29uT2JqZWN0ICYmIHBlcnNvbk9iamVjdC5wZXJzb25JZCl7XG4gICAgICAvL3VwZGF0ZVxuICAgICAgbGV0IGFkZHJlc3MgPSBwZXJzb25PYmplY3QuYWRkcmVzc0dyb3VwO1xuICAgICAgXG4gICAgICB0aGlzLl9sb2cubG9nKFwiUGVvcGxlIHNlcnZpY2UuYWRkcmVzcyA9IFwiLGFkZHJlc3MpO1xuICAgICAgLy9pbiB0aGUgZm9ybTsgYWRkcmVzcyBpcyBhIHN1YmZvcm0sIGl0IGNvbnRhaW5zIGFkZHJlc3Msd2FyZCxkaXN0cmljdCxwcm92aW5jZSxjb3VudHJ5OyB3ZSBuZWVkIHRvIGNvcHkgYWxsIHByb3BlcnRpZXMgdG8gZmF0aGVyIG9iamVjdCAgICAgIFxuICAgICAgcGVyc29uT2JqZWN0LmFkZHJlc3MgPSBhZGRyZXNzLmFkZHJlc3M7XG4gICAgICBwZXJzb25PYmplY3Qud2FyZCA9IGFkZHJlc3Mud2FyZDtcbiAgICAgIHBlcnNvbk9iamVjdC5zdWJ1cmJEaXN0cmljdCA9IGFkZHJlc3Muc3VidXJiRGlzdHJpY3Q7XG4gICAgICBwZXJzb25PYmplY3Quc3RhdGVQcm92aW5jZSA9IGFkZHJlc3Muc3RhdGVQcm92aW5jZTtcbiAgICAgIHBlcnNvbk9iamVjdC5wb3N0Y29kZSA9IGFkZHJlc3MucG9zdGNvZGU7XG4gICAgICBwZXJzb25PYmplY3QuY291bnRyeSA9IGFkZHJlc3MuY291bnRyeTtcbiAgICAgIFxuICAgICAgdGhpcy5fbG9nLmxvZyhcIndpbGwgdXBkYXRlIHRoaXMgcGVyc29uXCIscGVyc29uT2JqZWN0KTtcbiAgICAgIHRoaXMuX3Blb3BsZS51cGRhdGVBdHRyaWJ1dGVzKHBlcnNvbk9iamVjdC5wZXJzb25JZCxwZXJzb25PYmplY3QpLnN1YnNjcmliZShcbiAgICAgICAgZGF0YSA9PiB7XG4gICAgICAgICAgdGhpcy5fbG9nLmxvZyhkYXRhKTtcbi8qICAgICAgICAgIGxldCB1cGRhdGVkUGVyc29uID0gbmV3IFBlb3BsZShkYXRhKTtcbiAgICAgICAgICAvL3RoaXMuc2V0Q3VycmVudENvbXBhbnkodXBkYXRlZENvbXBhbnkpO1xuICAgICAgICAgIGxldCBwZXJzb25JbmRleCA9IF8uZmluZEluZGV4KHRoaXMucGVvcGxlLCB7cGVyc29uSWQ6IGRhdGEucGVyc29uSWR9KTtcblxuICAgICAgICAgIHRoaXMuX2xvZy5sb2coXCIgd2lsbCBmaW5kIHRoZSBjb21wYW55IHdpdGggaWQgPSBcIixkYXRhLnBlcnNvbklkKTtcbiAgICAgICAgICB0aGlzLl9sb2cubG9nKFwiIGZpbmQgY29tcGFueSBwb3NpdGlvbiA9IFwiICxwZXJzb25JbmRleCk7XG4gICAgICAgICAgdGhpcy5wZW9wbGVbcGVyc29uSW5kZXhdID0gdXBkYXRlZFBlcnNvbjsqL1xuICAgICAgICAgIG9ic2VydmVyLm5leHQoZGF0YSk7ICAgICAgICAgIFxuICAgICAgICB9LFxuICAgICAgICBlcnIgPT4ge3RoaXMuX2xvZy5sb2coZXJyKTt9LFxuICAgICAgICAoKSA9PiB7dGhpcy5fbG9nLmxvZygndXBkYXRlZCAhJyk7fVxuICAgICAgICApO1xuICAgIH1lbHNle1xuICAgICAgLy9jcmVhdGUgICAgICBcbiAgICAgIHBlcnNvbk9iamVjdC5wZXJzb25JZCA9IDA7XG5cbiAgICAgIGxldCBhZGRyZXNzID0gcGVyc29uT2JqZWN0LmFkZHJlc3NHcm91cDsgICAgICBcbiAgICAgIHRoaXMuX2xvZy5sb2coXCJQZW9wbGUgc2VydmljZS5hZGRyZXNzID0gXCIsYWRkcmVzcyk7XG4gICAgICAvL2luIHRoZSBmb3JtOyBhZGRyZXNzIGlzIGEgc3ViZm9ybSwgaXQgY29udGFpbnMgYWRkcmVzcyx3YXJkLGRpc3RyaWN0LHByb3ZpbmNlLGNvdW50cnk7IHdlIG5lZWQgdG8gY29weSBhbGwgcHJvcGVydGllcyB0byBmYXRoZXIgb2JqZWN0XG4gICAgICBwZXJzb25PYmplY3QuYWRkcmVzcyA9IGFkZHJlc3MuYWRkcmVzcztcbiAgICAgIHBlcnNvbk9iamVjdC53YXJkID0gYWRkcmVzcy53YXJkO1xuICAgICAgcGVyc29uT2JqZWN0LnN1YnVyYkRpc3RyaWN0ID0gYWRkcmVzcy5zdWJ1cmJEaXN0cmljdDtcbiAgICAgIHBlcnNvbk9iamVjdC5zdGF0ZVByb3ZpbmNlID0gYWRkcmVzcy5zdGF0ZVByb3ZpbmNlO1xuICAgICAgcGVyc29uT2JqZWN0LnBvc3Rjb2RlID0gYWRkcmVzcy5wb3N0Y29kZTtcbiAgICAgIHBlcnNvbk9iamVjdC5jb3VudHJ5ID0gYWRkcmVzcy5jb3VudHJ5O1xuXG4gICAgICB0aGlzLl9sb2cubG9nKFwiV2lsbCBjcmVhdGUgdGhpcyBwZXJzb25cIixwZXJzb25PYmplY3QpO1xuICAgICAgdGhpcy5fcGVvcGxlLmNyZWF0ZShwZXJzb25PYmplY3QpLnN1YnNjcmliZShcbiAgICAgICAgZGF0YSA9PiB7XG4vKiAgICAgICAgICBsZXQgdXBkYXRlZFBlcnNvbiA9IG5ldyBQZW9wbGUoZGF0YSlcbiAgICAgICAgICB0aGlzLl9sb2cubG9nKFwiY3JlYXRlZCBuZXcgcGVyc29uID0gXCIsdXBkYXRlZFBlcnNvbik7IFxuICAgICAgICAgIC8vdGhpcy5zZXRDdXJyZW50Q29tcGFueSh1cGRhdGVkQ29tcGFueSk7ICAgICAgICAgICBcbiAgICAgICAgICB0aGlzLnBlb3BsZS5wdXNoKHVwZGF0ZWRQZXJzb24pOyovXG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChkYXRhKTsgXG4gICAgICAgIH0sXG4gICAgICAgIGVyciA9PiB7dGhpcy5fbG9nLmxvZyhlcnIpO30sXG4gICAgICAgICgpID0+IHt0aGlzLl9sb2cubG9nKCdjcmVhdGVkICEnKTt9XG4gICAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBvYnM7XG4gIH1cblxuICAvKlxuICBzZXRDdXJyZW50Q29tcGFueShjb21wYW55OiBDb21wYW55KTogdm9pZHsgICAgXG4gICAgdGhpcy5jdXJyZW50Q29tcGFueSA9IGNvbXBhbnk7XG4gICAgY29uc29sZS5sb2coXCJzZXQgY3VycmVudCBjb21wYW55ID0gXCIsdGhpcy5jdXJyZW50Q29tcGFueSk7XG4gIH1cblxuICBnZXRDdXJyZW50Q29tcGFueSgpOiBDb21wYW55IHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50Q29tcGFueTtcbiAgfVxuXG4gIHNldEN1cnJlbnRDbGluaWMoY2xpbmljOiBDbGluaWMpOiB2b2lkeyAgICBcbiAgICB0aGlzLmN1cnJlbnRDbGluaWMgPSBjbGluaWM7XG4gIH1cblxuICBnZXRDdXJyZW50Q2xpbmljKCk6IENsaW5pYyB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudENsaW5pYztcbiAgfVxuXG4gIHNhdmVDb21wYW55KGNvbXBhbnlPYmplY3QpOiBPYnNlcnZhYmxlPGFueT57XG4gICAgbGV0IG9ic2VydmVyOmFueTtcbiAgICBsZXQgb2JzID0gbmV3IE9ic2VydmFibGUobyA9PiBvYnNlcnZlciA9IG8pO1xuICAgIGlmKHRoaXMuY3VycmVudENvbXBhbnkgJiYgdGhpcy5jdXJyZW50Q29tcGFueS5jb21wYW55SWQpe1xuICAgICAgLy91cGRhdGVcbiAgICAgIHRoaXMuX2xvZy5sb2coXCJ3aWxsIHVwZGF0ZSB0aGlzIGNvbXBhbnlcIixjb21wYW55T2JqZWN0KTtcbiAgICAgIHRoaXMuX2NvbXBhbmllcy51cGRhdGVBdHRyaWJ1dGVzKHRoaXMuY3VycmVudENvbXBhbnkuY29tcGFueUlkLGNvbXBhbnlPYmplY3QpLnN1YnNjcmliZShcbiAgICAgICAgZGF0YSA9PiB7XG4gICAgICAgICAgdGhpcy5fbG9nLmxvZyhkYXRhKTtcbiAgICAgICAgICBsZXQgdXBkYXRlZENvbXBhbnkgPSBuZXcgQ29tcGFueShkYXRhKVxuICAgICAgICAgIHRoaXMuc2V0Q3VycmVudENvbXBhbnkodXBkYXRlZENvbXBhbnkpO1xuICAgICAgICAgIGxldCBjb21wYW55SW5kZXggPSBfLmZpbmRJbmRleCh0aGlzLmNvbXBhbmllcywge2NvbXBhbnlJZDogZGF0YS5jb21wYW55SWR9KTtcblxuICAgICAgICAgIHRoaXMuX2xvZy5sb2coXCIgd2lsbCBmaW5kIHRoZSBjb21wYW55IHdpdGggaWQgPSBcIixkYXRhLmNvbXBhbnlJZCk7XG4gICAgICAgICAgdGhpcy5fbG9nLmxvZyhcIiBmaW5kIGNvbXBhbnkgcG9zaXRpb24gPSBcIiAsY29tcGFueUluZGV4KTtcbiAgICAgICAgICB0aGlzLmNvbXBhbmllc1tjb21wYW55SW5kZXhdID0gdXBkYXRlZENvbXBhbnk7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChkYXRhKTsgICAgICAgICAgXG4gICAgICAgIH0sXG4gICAgICAgIGVyciA9PiB7dGhpcy5fbG9nLmxvZyhlcnIpO30sXG4gICAgICAgICgpID0+IHt0aGlzLl9sb2cubG9nKCd1cGRhdGVkICEnKTt9XG4gICAgICAgICk7XG4gICAgfWVsc2V7XG4gICAgICAvL2NyZWF0ZSAgICAgIFxuICAgICAgY29tcGFueU9iamVjdC5jb21wYW55SWQgPSAwO1xuICAgICAgdGhpcy5fbG9nLmxvZyhcIldpbGwgY3JlYXRlIHRoaXMgY29tcGFueVwiLGNvbXBhbnlPYmplY3QpO1xuICAgICAgdGhpcy5fY29tcGFuaWVzLmNyZWF0ZShjb21wYW55T2JqZWN0KS5zdWJzY3JpYmUoXG4gICAgICAgIGRhdGEgPT4ge1xuICAgICAgICAgIGxldCB1cGRhdGVkQ29tcGFueSA9IG5ldyBDb21wYW55KGRhdGEpXG4gICAgICAgICAgdGhpcy5fbG9nLmxvZyhkYXRhKTsgXG4gICAgICAgICAgdGhpcy5zZXRDdXJyZW50Q29tcGFueSh1cGRhdGVkQ29tcGFueSk7IFxuICAgICAgICAgIG9ic2VydmVyLm5leHQoZGF0YSk7IFxuICAgICAgICAgIHRoaXMuY29tcGFuaWVzLnB1c2godXBkYXRlZENvbXBhbnkpO1xuICAgICAgICB9LFxuICAgICAgICBlcnIgPT4ge3RoaXMuX2xvZy5sb2coZXJyKTt9LFxuICAgICAgICAoKSA9PiB7dGhpcy5fbG9nLmxvZygnY3JlYXRlZCAhJyk7fVxuICAgICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gb2JzO1xuICB9XG5cbiAgc2F2ZUNsaW5pYyhjbGluaWNPYmplY3QpOiBPYnNlcnZhYmxlPGFueT57XG4gICAgbGV0IG9ic2VydmVyOmFueTtcbiAgICBsZXQgb2JzID0gbmV3IE9ic2VydmFibGUobyA9PiBvYnNlcnZlciA9IG8pO1xuXG4gICAgaWYodGhpcy5jdXJyZW50Q2xpbmljICYmIHRoaXMuY3VycmVudENsaW5pYy5jbGluaWNJZCl7XG4gICAgICAvL3VwZGF0ZVxuICAgICAgdGhpcy5fbG9nLmxvZyhcIndpbGwgdXBkYXRlIHRoaXMgY2xpbmljXCIsY2xpbmljT2JqZWN0KTtcbiAgICAgIHRoaXMuX2NvbXBhbmllcy5fX3VwZGF0ZUJ5SWRfX0NsaW5pY3ModGhpcy5jdXJyZW50Q29tcGFueS5jb21wYW55SWQsdGhpcy5jdXJyZW50Q2xpbmljLmNsaW5pY0lkLGNsaW5pY09iamVjdCkuc3Vic2NyaWJlKFxuICAgICAgICBkYXRhID0+IHtcbiAgICAgICAgICBsZXQgdXBkYXRlZENsaW5pYyA9IG5ldyBDbGluaWMoZGF0YSlcbiAgICAgICAgICB0aGlzLl9sb2cubG9nKGRhdGEpO1xuICAgICAgICAgIHRoaXMuc2V0Q3VycmVudENsaW5pYyh1cGRhdGVkQ2xpbmljKTtcbiAgICAgICAgICBsZXQgY2xpbmljSW5kZXggPSBfLmZpbmRJbmRleCh0aGlzLmN1cnJlbnRDb21wYW55LmNsaW5pY3MsIHtjbGluaWNJZDogZGF0YS5jbGluaWNJZH0pO1xuXG4gICAgICAgICAgdGhpcy5fbG9nLmxvZyhcIiB3aWxsIGZpbmQgdGhlIGNvbXBhbnkgd2l0aCBpZCA9IFwiLGRhdGEuY2xpbmljSWQpO1xuICAgICAgICAgIHRoaXMuX2xvZy5sb2coXCIgZmluZCBjb21wYW55IHBvc2l0aW9uID0gXCIgLGNsaW5pY0luZGV4KTtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRDb21wYW55LmNsaW5pY3NbY2xpbmljSW5kZXhdID0gdXBkYXRlZENsaW5pYztcbiAgICAgICAgICBvYnNlcnZlci5uZXh0KGRhdGEpOyAgICAgICAgICBcbiAgICAgICAgfSxcbiAgICAgICAgZXJyID0+IHt0aGlzLl9sb2cubG9nKGVycik7fSxcbiAgICAgICAgKCkgPT4ge3RoaXMuX2xvZy5sb2coJ3VwZGF0ZWQgIScpO31cbiAgICAgICAgKTtcbiAgICB9ZWxzZXtcbiAgICAgIC8vY3JlYXRlICAgICAgXG4gICAgICBjbGluaWNPYmplY3QuY29tcGFueUlkID0gdGhpcy5jdXJyZW50Q29tcGFueS5jb21wYW55SWQ7XG4gICAgICBjbGluaWNPYmplY3QuY2xpbmljSWQgPSAwO1xuICAgICAgdGhpcy5fbG9nLmxvZyhcIldpbGwgY3JlYXRlIHRoaXMgY29tcGFueVwiLGNsaW5pY09iamVjdCk7XG4gICAgICB0aGlzLl9jb21wYW5pZXMuX19jcmVhdGVfX0NsaW5pY3ModGhpcy5jdXJyZW50Q29tcGFueS5jb21wYW55SWQsY2xpbmljT2JqZWN0KS5zdWJzY3JpYmUoXG4gICAgICAgIGRhdGEgPT4ge1xuICAgICAgICAgIGxldCB1cGRhdGVkQ2xpbmljID0gbmV3IENsaW5pYyhkYXRhKVxuICAgICAgICAgIHRoaXMuX2xvZy5sb2coZGF0YSk7IFxuICAgICAgICAgIHRoaXMuc2V0Q3VycmVudENsaW5pYyh1cGRhdGVkQ2xpbmljKTtcbiAgICAgICAgICBvYnNlcnZlci5uZXh0KGRhdGEpOyBcbiAgICAgICAgICBjb25zb2xlLmxvZyhcImNyZWF0ZWQgY2xpbmMsIGN1cnJlbnQgY29tcGFueSA9XCIsdGhpcy5jdXJyZW50Q29tcGFueSk7XG4gICAgICAgICAgdGhpcy5jdXJyZW50Q29tcGFueS5jbGluaWNzLnB1c2godXBkYXRlZENsaW5pYyk7XG4gICAgICAgIH0sXG4gICAgICAgIGVyciA9PiB7dGhpcy5fbG9nLmxvZyhlcnIpO30sXG4gICAgICAgICgpID0+IHt0aGlzLl9sb2cubG9nKCdjcmVhdGVkICEnKTt9XG4gICAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBvYnM7XG4gIH1cbiAgKi9cbn1cbiJdfQ==
